import{o as C,b as I,c as T,d as m,e as M}from"./app-Cv71cVJ1.js";import{query as h,collection as b,onSnapshot as E,where as $,doc as H,getDoc as S}from"https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";import"https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";const r=(e,s=!0)=>Toastify({text:e,duration:3e3,gravity:"top",position:"right",backgroundColor:s?"#16a34a":"#dc2626"}).showToast();let o=null,u=null,l=null;const k=document.getElementById("userEmail"),A=document.getElementById("logoutBtn"),p=document.getElementById("caseForm"),y=document.getElementById("submitCase"),f=document.getElementById("caseBtnText"),c=document.getElementById("casesList"),q=document.getElementById("selectedCaseInfo"),U=document.getElementById("chatArea"),i=document.getElementById("messages"),v=document.getElementById("chatInput"),D=document.getElementById("sendMsgBtn");function x(e){e?(f.innerHTML='<span class="loader"></span> Sending...',y.disabled=!0):(f.innerHTML='<i class="fa-solid fa-paper-plane"></i> Submit',y.disabled=!1)}C(async e=>{if(!e){window.location.href="/login.html";return}o=e,k.textContent=o.user.email,F()});A.addEventListener("click",async()=>{await I(),window.location.href="/login.html"});p.addEventListener("submit",async e=>{e.preventDefault();const s=document.getElementById("disease").value,a=document.getElementById("symptoms").value.trim();if(!s||!a){r("Please select disease and write symptoms",!1);return}x(!0);try{const t=await T({patientId:o.user.uid,patientEmail:o.user.email,reportedByUid:o.user.uid,disease:s,notes:a,status:"pending"});r("Case submitted"),p.reset(),w(t)}catch(t){console.error(t),r("Failed to submit case",!1)}finally{x(!1)}});async function F(){c.innerHTML='<p class="text-gray-400">Loading cases...</p>';const e=h(b(m,"cases"),$("patientId","==",o.user.uid));E(e,s=>{if(s.empty){c.innerHTML='<p class="text-gray-500">No cases yet</p>';return}const a=s.docs.map(t=>{const n=t.data();return`<div class="p-2 border rounded flex items-start justify-between">
            <div>
              <div class="font-semibold">${n.disease||"Unknown"}</div>
              <div class="text-xs text-gray-500">Status: ${n.status||"pending"}</div>
              <div class="text-xs text-gray-500 mt-1">${n.notes?n.notes.length>80?n.notes.slice(0,80)+"...":n.notes:""}</div>
            </div>
            <div class="flex flex-col gap-2 ml-3">
              <button data-id="${t.id}" class="open-chat px-2 py-1 bg-green-600 text-white rounded text-xs">Chat</button>
              <button data-id="${t.id}" class="view-case px-2 py-1 bg-gray-100 rounded text-xs">View</button>
            </div>
          </div>`});c.innerHTML=a.join(""),document.querySelectorAll(".open-chat").forEach(t=>t.addEventListener("click",n=>{w(n.currentTarget.dataset.id)})),document.querySelectorAll(".view-case").forEach(t=>t.addEventListener("click",n=>{N(n.currentTarget.dataset.id)}))},s=>{console.error(s),c.innerHTML='<p class="text-red-500">Failed to load cases</p>'})}async function N(e){const s=H(m,"cases",e),a=await S(s);if(!a.exists())return r("Case not found",!1);const t=a.data();alert(`Case: ${j(t.disease)}
Status: ${t.status}
Notes: ${t.notes||""}
Created: ${t.createdAt?t.createdAt.toDate():"N/A"}`)}function j(e){return e||"Unknown"}function w(e){u=e,q.textContent="Case: "+e,U.classList.remove("hidden"),i.innerHTML='<div class="text-gray-400 text-sm">Loading messages...</div>',l&&l();const s=`chats/${e}/messages`,a=h(b(m,s));l=E(a,t=>{if(t.empty){i.innerHTML='<div class="text-gray-500 p-2">No messages yet. Start the conversation.</div>';return}const n=t.docs.map(L=>{const d=L.data(),g=d.from===o.user.uid,B=d.createdAt?new Date(d.createdAt.seconds*1e3).toLocaleString():"";return`<div class="mb-2 ${g?"text-right":""}">
            <div class="${g?"inline-block bg-green-600 text-white px-3 py-1 rounded-lg":"inline-block bg-gray-200 px-3 py-1 rounded-lg"}">${O(d.text)}</div>
            <div class="text-xs text-gray-400 mt-1">${B}</div>
          </div>`}).join("");i.innerHTML=n,i.scrollTop=i.scrollHeight},t=>{console.error(t),i.innerHTML='<div class="text-red-500">Chat load failed</div>'})}D.addEventListener("click",async()=>{const e=v.value.trim();if(e){if(!u)return r("Select a case first",!1);try{await M(u,o.user.uid,e),v.value=""}catch(s){console.error(s),r("Failed to send message",!1)}}});function O(e){return String(e).replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[s])}
