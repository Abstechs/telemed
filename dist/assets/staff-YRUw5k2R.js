import{o as w,b,d as i}from"./app-BBxhuRp7.js";import{query as u,collection as m,onSnapshot as C,doc as y,getDocs as c,where as f,updateDoc as E}from"https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";import"https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";const d=(t,e=!0)=>Toastify({text:t,duration:3e3,gravity:"top",position:"right",backgroundColor:e?"#16a34a":"#dc2626"}).showToast();let g=null,v=null;const B=document.getElementById("staffEmail"),I=document.getElementById("logout"),l=document.getElementById("casesArea"),p=document.getElementById("caseInfo"),T=document.getElementById("caseDetailTitle"),x=document.getElementById("resultText"),h=document.getElementById("statusSelect"),$=document.getElementById("updateBtn");document.getElementById("openChat");let r=null;function S(t){const e=document.getElementById("miniChart").getContext("2d"),s=Object.keys(t),a=Object.values(t);r&&r.destroy(),r=new Chart(e,{type:"doughnut",data:{labels:s,datasets:[{data:a}]},options:{responsive:!0,plugins:{legend:{position:"bottom"}}}})}w(t=>{if(!t){window.location.href="/login.html";return}g=t,B.textContent=g.user.email,_()});I.addEventListener("click",async()=>{await b(),window.location.href="/login.html"});function _(){const t=u(m(i,"cases"));C(t,e=>{if(e.empty){l.innerHTML='<div class="text-gray-500">No cases</div>';return}const s={},a=e.docs.map(n=>{const o=n.data();return s[o.disease]=(s[o.disease]||0)+1,{id:n.id,data:o}});S(s),l.innerHTML=a.map(n=>{const o=n.data;return`<div class="p-2 border rounded flex items-center justify-between">
            <div>
              <div class="font-semibold">${o.disease||"Unknown"}</div>
              <div class="text-xs text-gray-500">${o.patientEmail||""}</div>
              <div class="text-xs text-gray-500">Status: ${o.status||"pending"}</div>
            </div>
            <div class="flex flex-col gap-2">
              <button data-id="${n.id}" class="viewCase px-2 py-1 rounded bg-green-600 text-white text-xs">Open</button>
              <button data-id="${n.id}" class="chatCase px-2 py-1 rounded bg-gray-100 text-xs">Chat</button>
            </div>
          </div>`}).join(""),k()},e=>{console.error(e),l.innerHTML='<div class="text-red-500">Failed to load cases</div>'})}function k(){document.querySelectorAll(".viewCase").forEach(t=>t.addEventListener("click",async e=>{const s=e.currentTarget.dataset.id;L(s)})),document.querySelectorAll(".chatCase").forEach(t=>t.addEventListener("click",async e=>{const s=e.currentTarget.dataset.id;q(s)}))}async function L(t){v=t,T.textContent=`Case: ${t}`;const e=y(i,"cases",t);await c,await(async()=>await e.get?await e.get():await c(u(m(i,"cases"),f("__name__","==",t))))();const s=await(async()=>{const n=u(m(i,"cases"),f("__name__","==",t));return(await c(n)).docs[0]})();if(!s){p.textContent="Case not found";return}const a=s.data();p.innerHTML=`<div class="text-sm"><b>Disease:</b> ${a.disease||""}</div><div class="text-sm mt-1"><b>Patient:</b> ${a.patientEmail||""}</div><div class="text-sm mt-1"><b>Status:</b> ${a.status||""}</div><div class="text-sm mt-2"><b>Notes:</b> ${a.notes||""}</div>`,x.value=a.result||"",h.value=a.status||"pending"}$.addEventListener("click",async()=>{if(!v)return d("Select a case first",!1);const t=x.value.trim(),e=h.value;try{await E(y(i,"cases",v),{result:t,status:e}),d("Case updated")}catch(s){console.error(s),d("Update failed",!1)}});function q(t){window.open(`/staff.html?chat=${t}`,"_blank")}
