<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TeleMed — Lab Technician Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <!-- Chart.js for small charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <style>
    .card { background:white; border-radius:10px; padding:12px; box-shadow:0 6px 18px rgba(8,41,18,0.06) }
    .loader { border:3px solid rgba(0,0,0,0.05); border-top:3px solid white; border-radius:50%; width:12px; height:12px; animation:spin .9s linear infinite; display:inline-block; }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body class="bg-white min-h-screen">
  <header class="bg-green-600 text-white">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="p-2 rounded bg-green-800"><i class="fa-solid fa-vial"></i></div>
        <div>
          <div class="font-bold">TeleMed</div>
          <div class="text-xs">Lab technician</div>
        </div>
      </div>
      <div>
        <span id="staffEmail" class="text-sm mr-4"></span>
        <button id="logout" class="px-3 py-1 bg-white/20 rounded">Logout</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left: cases queue -->
    <section class="lg:col-span-2 card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Cases queue</h2>
        <div class="text-sm text-gray-500">Realtime feed</div>
      </div>
      <div id="casesArea" class="space-y-3 text-sm text-gray-700">
        <div class="text-gray-400">Loading cases...</div>
      </div>
    </section>

    <!-- Right: selected case + update form + small chart -->
    <aside class="card">
      <div id="caseDetailTitle" class="font-semibold mb-2">Select a case to view</div>

      <div id="caseDetail" class="text-sm text-gray-700 mb-3">
        <div id="caseInfo">No case selected</div>
      </div>

      <div id="resultSection" class="space-y-2">
        <label class="block text-xs text-gray-600">Enter result / notes</label>
        <textarea id="resultText" rows="4" class="w-full border rounded px-2 py-2"></textarea>
        <select id="statusSelect" class="w-full border rounded px-2 py-2">
          <option value="pending">Pending</option>
          <option value="in-progress">In progress</option>
          <option value="completed">Completed</option>
        </select>
        <button id="updateBtn" class="w-full bg-green-600 text-white py-2 rounded">Update case</button>
        <button id="openChat" class="w-full mt-2 bg-gray-100 py-2 rounded">Open chat</button>
      </div>

      <div class="mt-4">
        <h3 class="text-sm font-semibold mb-2">Cases (last 30 days)</h3>
        <canvas id="miniChart" width="300" height="220"></canvas>
      </div>
    </aside>
  </main>

  <script type="module">
    import {
      onAuthWithProfile,
      db,
      collection,
      query,
      getDocs,
      onSnapshot,
      where,
      updateDoc,
      doc,
      sendChatMessage,
      signOutUser
    } from '../src/js/app.js';

    const toast = (m, ok=true) => Toastify({ text:m, duration:3000, gravity:'top', position:'right', backgroundColor: ok? '#16a34a' : '#dc2626' }).showToast();

    let me = null;
    let selectedCaseId = null;

    const staffEmail = document.getElementById('staffEmail');
    const logout = document.getElementById('logout');
    const casesArea = document.getElementById('casesArea');
    const caseInfo = document.getElementById('caseInfo');
    const caseDetailTitle = document.getElementById('caseDetailTitle');
    const resultText = document.getElementById('resultText');
    const statusSelect = document.getElementById('statusSelect');
    const updateBtn = document.getElementById('updateBtn');
    const openChat = document.getElementById('openChat');

    // chart
    let miniChart = null;
    function drawMiniChart(data) {
      const ctx = document.getElementById('miniChart').getContext('2d');
      const labels = Object.keys(data);
      const values = Object.values(data);
      if (miniChart) miniChart.destroy();
      miniChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values }] },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }

    onAuthWithProfile((state) => {
      if (!state) { window.location.href = '/login.html'; return; }
      me = state;
      staffEmail.textContent = me.user.email;
      loadCasesRealtime();
    });

    logout.addEventListener('click', async ()=> { await signOutUser(); window.location.href = '/login.html'; });

    // listen to all cases realtime
    function loadCasesRealtime() {
      const q = query(collection(db, 'cases'));
      onSnapshot(q, (snap) => {
        if (snap.empty) { casesArea.innerHTML = '<div class="text-gray-500">No cases</div>'; return; }
        // aggregate for chart
        const counts = {};
        const nodes = snap.docs.map(d => {
          const data = d.data();
          counts[data.disease] = (counts[data.disease] || 0) + 1;
          return { id: d.id, data };
        });
        drawMiniChart(counts);

        casesArea.innerHTML = nodes.map(n => {
          const d = n.data;
          return `<div class="p-2 border rounded flex items-center justify-between">
            <div>
              <div class="font-semibold">${d.disease || 'Unknown'}</div>
              <div class="text-xs text-gray-500">${d.patientEmail || ''}</div>
              <div class="text-xs text-gray-500">Status: ${d.status || 'pending'}</div>
            </div>
            <div class="flex flex-col gap-2">
              <button data-id="${n.id}" class="viewCase px-2 py-1 rounded bg-green-600 text-white text-xs">Open</button>
              <button data-id="${n.id}" class="chatCase px-2 py-1 rounded bg-gray-100 text-xs">Chat</button>
            </div>
          </div>`;
        }).join('');
        attachCaseButtons();
      }, (err) => { console.error(err); casesArea.innerHTML = '<div class="text-red-500">Failed to load cases</div>'; });
    }

    function attachCaseButtons() {
      document.querySelectorAll('.viewCase').forEach(b => b.addEventListener('click', async (ev) => {
        const id = ev.currentTarget.dataset.id; selectCase(id);
      }));
      document.querySelectorAll('.chatCase').forEach(b => b.addEventListener('click', async (ev) => {
        const id = ev.currentTarget.dataset.id; openChatForCase(id);
      }));
    }

    async function selectCase(id) {
      selectedCaseId = id;
      caseDetailTitle.textContent = `Case: ${id}`;
      const dref = doc(db, 'cases', id);
      const snap = await getDocs ? null : null; // placeholder to avoid bundler linter
      const full = await (async()=> { const s = await dref.get ? await dref.get() : await getDocs(query(collection(db,'cases'), where('__name__','==',id))); return s; })();
      // Simpler: use getDoc import if needed; but we already have doc & updateDoc
      // Using getDoc via simple dynamic import to avoid breaking; simpler approach follows:
      const docSnap = await (async () => {
        // getDoc not exported directly as getDoc function in some builds — use getDocs filter:
        const q = query(collection(db, 'cases'), where('__name__', '==', id));
        const res = await getDocs(q);
        return res.docs[0];
      })();
      if (!docSnap) { caseInfo.textContent = 'Case not found'; return; }
      const d = docSnap.data();
      caseInfo.innerHTML = `<div class="text-sm"><b>Disease:</b> ${d.disease || ''}</div><div class="text-sm mt-1"><b>Patient:</b> ${d.patientEmail || ''}</div><div class="text-sm mt-1"><b>Status:</b> ${d.status || ''}</div><div class="text-sm mt-2"><b>Notes:</b> ${d.notes || ''}</div>`;
      resultText.value = d.result || '';
      statusSelect.value = d.status || 'pending';
    }

    updateBtn.addEventListener('click', async () => {
      if (!selectedCaseId) return toast('Select a case first', false);
      const newResult = resultText.value.trim();
      const newStatus = statusSelect.value;
      try {
        await updateDoc(doc(db, 'cases', selectedCaseId), { result: newResult, status: newStatus });
        toast('Case updated');
      } catch (err) {
        console.error(err);
        toast('Update failed', false);
      }
    });

    function openChatForCase(caseId) {
      // Open chat in new tab to patient view chat - simple pattern
      window.open(`/staff.html?chat=${caseId}`, '_blank');
    }

  </script>
</body>
</html>
